{% extends "base.html" %}
{% load static %}
{% block title %}Chat{% endblock %}

{% block content %}
<style>
    .profile-picture {
        width: 80px;
        height: 80px;
        object-fit: cover;
        margin-right: 20px;
    }

</style>
<div class="container mt-4">
    <div class="card">
        <div class="card-header d-flex align-items-center">
            {% if receiver.profile.profile_picture %}
                <img src="{{ receiver.profile.profile_picture.url }}" alt="Profile Picture" class="rounded-circle mr-3 profile-picture" style="width: 50px; height: 50px;">
            {% else %}
                <img src="{% static 'default_profile_picture.png' %}" alt="Default Profile Picture" class="rounded-circle mr-3" style="width: 50px; height: 50px;">
            {% endif %}
            <h3 class="mb-0"><a href="{% url 'user_profile' receiver.username %}" class="text-decoration-none text-dark">{{ receiver.username }}</a></h3>
        </div>
        <div class="card-body" id="chat-log" style="height: 400px; overflow-y: auto; display: flex; flex-direction: column;">
            {% for message in chat_messages %}
                <div class="d-flex {% if message.sender == user %}justify-content-end{% else %}justify-content-start{% endif %} mb-2">
                    <div class="rounded p-2 {% if message.sender == user %}bg-primary text-white{% else %}bg-light{% endif %}">
                        {{ message.content }}
                    </div>
                </div>
            {% endfor %}
        </div>
        <div class="card-footer">
            <div class="input-group">
                <input id="chat-message-input" type="text" class="form-control" placeholder="Type a message..." title="Type your message here">
                <div class="input-group-append">
                    <button id="chat-message-submit" class="btn btn-primary" title="Send your message">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    const username = "{{ receiver.username }}";  // Embed the receiver's username in the JavaScript code
    const chatSocket = new WebSocket(
        'ws://' + window.location.hostname + ':8001/ws/chat/' + username + '/'
    );

    chatSocket.onopen = function(e) {
        console.log('WebSocket connection established');
    };

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log('Message received:', data);
        const chatLog = document.querySelector('#chat-log');
        const newMessage = document.createElement('div');
        newMessage.classList.add('d-flex', 'mb-2');
        if (data.sender === '{{ user.username }}') {
            newMessage.classList.add('justify-content-end');
            newMessage.innerHTML = `<div class="rounded p-2 bg-primary text-white">${data.message}</div>`;
        } else {
            newMessage.classList.add('justify-content-start');
            newMessage.innerHTML = `<div class="rounded p-2 bg-light">${data.message}</div>`;
        }
        chatLog.appendChild(newMessage);
        chatLog.scrollTop = chatLog.scrollHeight;  // Auto-scroll to the bottom
    };

    chatSocket.onerror = function(e) {
        console.error('WebSocket Error:', e);
    };

    chatSocket.onclose = function(e) {
        console.log('Chat socket closed unexpectedly', e);
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        messageInputDom.value = '';
    };

    // Ensure the chat log is scrolled to the bottom when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        const chatLog = document.querySelector('#chat-log');
        chatLog.scrollTop = chatLog.scrollHeight;
    });
</script>
{% endblock %}
