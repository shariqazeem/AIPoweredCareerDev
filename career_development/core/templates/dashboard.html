{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

<style>
    .dashboard-container {
        display: flex;
    }
    .sidebar {
        width: 250px;
        height: 100vh;
        padding-top: 20px;
        position: fixed;
        background-color: #2c2f33;
        color: #ffffff;
    }
    .sidebar a {
        color: #ffffff;
        padding: 10px;
        text-decoration: none;
        display: block;
        transition: background-color 0.3s, color 0.3s;
    }
    .sidebar a:hover {
        background-color: #ff4081;
        color: #ffffff;
    }
    .content {
        flex-grow: 1;
        padding: 2rem;
        margin-left: 250px;
        background-color: #171c28;
        color: #ffffff;
        width: calc(100% - 250px);
        transition: margin-left 0.3s ease;
    }
    .card {
        border-radius: 20px;
        border: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
        width: 100%;
        max-width: 800px;
        overflow-wrap: break-word;
        background-color: #2c2f33;
        color: #ffffff;
    }
    .card:hover {
        transform: translateY(-5px);
        transition: transform 0.2s;
    }
    .card-body {
        padding: 1.5rem;
    }
    .card-title {
        font-size: 1.5rem;
        border-bottom: 2px solid #ff4081;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
    .btn-primary {
        background-color: #ff4081;
        border-color: #ff4081;
        transition: background-color 0.3s, border-color 0.3s;
    }
    .btn-primary:hover {
        background-color: #e91e63;
        border-color: #e91e63;
    }
    .spinner-border {
        display: none;
        margin-left: 5px;
    }
    .loading .spinner-border {
        display: inline-block;
    }
    .loading .btn-text {
        display: none;
    }
    .profile-picture {
        width: 80px;
        height: 80px;
        object-fit: cover;
        margin-right: 20px;
    }

    /* Responsive styles */
    @media (max-width: 768px) {
        .sidebar {
            display: none;
        }
        .content {
            margin-left: 0;
            width: 100%;
            padding: 1rem;
        }
    }
    .fade-in {
    animation: fadeIn 1s ease-in-out;
}

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

</style>

<div class="dashboard-container">
    <div class="sidebar fade-in">
        <h2 class="text-center">VisionVenture</h2>
        <a href="#career-recommendations-section"><i class="fas fa-bullseye"></i> Career Recommendations</a>
        <a href="#job-prospects-section"><i class="fas fa-briefcase"></i> Job Prospects</a>
        <a href="#assess-skills-section"><i class="fas fa-chart-bar"></i> Assess Skills</a>
        <a href="#resume-advice-section"><i class="fas fa-file-alt"></i> Resume Advice</a>
        <a href="#match-jobs-section"><i class="fas fa-handshake"></i> Match Jobs</a>
        <a href="#learning-resources-section"><i class="fas fa-book"></i> Learning Resources</a>
        <a href="#networking-opportunities-section"><i class="fas fa-users"></i> Networking Opportunities</a>
        <a href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>
    <div class="content fade-in">
        <div class="card fade-in">
            <div class="card-body">
                <div class="profile-section d-flex align-items-center">
                    {% if user.profile.profile_picture %}
                        <img src="{{ user.profile.profile_picture.url }}" alt="Profile Picture" class="rounded-circle profile-picture">
                    {% else %}
                        <img src="https://via.placeholder.com/80" alt="Profile Picture" class="rounded-circle profile-picture">
                    {% endif %}
                    <div>
                        <h2 class="m-0">{{ user.username }}</h2>
                        <p class="m-0">{{ user.email }}</p>
                    </div>
                    <div class="profile-actions">
                        <a href="{% url 'profile' %}" class="btn btn-sm btn-dark ms-3">Edit Profile</a>
                    </div>
                </div>
            </div>
        </div>

        <div id="skill-assessment-section" class="card fade-in">
            <div class="card-body">
                <h3 class="card-title">Skill Assessment</h3>
                <canvas id="skillAssessmentChart" width="200" height="100"></canvas>
            </div>
        </div>

        <!-- Career Recommendations -->
        <div id="career-recommendations-section" class="card fade-in">
            <div class="card-body">
                <h3 class="card-title">Career Recommendations</h3>
                <button id="get-career-recommendations-btn" class="btn btn-primary w-100 mb-3">
                    <span class="btn-text">Get Recommendations</span>
                    <span class="spinner-border" role="status" aria-hidden="true"></span>
                </button>
                <div id="career-recommendations" class="mt-4">
                    {% if profile.career_recommendations %}
                        <div>{{ profile.career_recommendations|safe }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div id="job-prospects-section" class="card fade-in">
            <div class="card-body">
                <h3 class="card-title">Job Prospects</h3>
                <button id="get-job-prospects-btn" class="btn btn-primary w-100 mb-3">
                    <span class="btn-text">Get Job Prospects</span>
                    <span class="spinner-border" role="status" aria-hidden="true"></span>
                </button>
                <div id="job-prospects" class="mt-4">
                    {% if profile.job_prospects %}
                        <div>{{ profile.job_prospects|safe }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div id="assess-skills-section" class="card fade-in">
            <div class="card-body">
                <h3 class="card-title">Assess Skills</h3>
                <button id="assess-skills-btn" class="btn btn-primary w-100 mb-3">
                    <span class="btn-text">Assess Skills</span>
                    <span class="spinner-border" role="status" aria-hidden="true"></span>
                </button>
                <div id="skill-assessment" class="mt-4">
                    {% if profile.skill_assessment %}
                        <div>{{ profile.skill_assessment|safe }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div id="resume-advice-section" class="card fade-in">
            <div class="card-body">
                <h3 class="card-title">Resume Advice</h3>
                <button id="get-resume-advice-btn" class="btn btn-primary w-100 mb-3">
                    <span class="btn-text">Get Advice</span>
                    <span class="spinner-border" role="status" aria-hidden="true"></span>
                </button>
                <div id="resume-advice" class="mt-4">
                    {% if profile.resume_advice %}
                        <div>{{ profile.resume_advice|safe }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div id="match-jobs-section" class="card fade-in">
            <div class="card-body">
                <h3 class="card-title">Match Jobs</h3>
                <button id="match-jobs-btn" class="btn btn-primary w-100 mb-3">
                    <span class="btn-text">Match Jobs</span>
                    <span class="spinner-border" role="status" aria-hidden="true"></span>
                </button>
                <div id="matched-jobs" class="mt-4">
                    {% if profile.matched_jobs %}
                        <div>{{ profile.matched_jobs|safe }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div id="learning-resources-section" class="card fade-in">
            <div class="card-body">
                <h3 class="card-title">Learning Resources</h3>
                <button id="get-learning-resources-btn" class="btn btn-primary w-100 mb-3">
                    <span class="btn-text">Get Resources</span>
                    <span class="spinner-border" role="status" aria-hidden="true"></span>
                </button>
                <div id="learning-resources" class="mt-4">
                    {% if profile.learning_resources %}
                        <div>{{ profile.learning_resources|safe }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div id="networking-opportunities-section" class="card fade-in">
            <div class="card-body">
                <h3 class="card-title">Networking Opportunities</h3>
                <button id="find-networking-opportunities-btn" class="btn btn-primary w-100 mb-3">
                    <span class="btn-text">Find Opportunities</span>
                    <span class="spinner-border" role="status" aria-hidden="true"></span>
                </button>
                <div id="networking-opportunities" class="mt-4">
                    {% if profile.networking_opportunities %}
                        <div>{{ profile.networking_opportunities|safe }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function setLoadingState(button, loading) {
        if (loading) {
            button.classList.add('loading');
            button.disabled = true;
        } else {
            button.classList.remove('loading');
            button.disabled = false;
        }
    }

    function formatText(text) {
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
        text = text.replace(/\*(.*?)\*/g, '<em>$1</em>'); 
        text = text.replace(/\n/g, '<br>'); 
        return text;
    }

    function handleButtonClick(buttonId, url, resultSelector, resultKey) {
        const button = document.getElementById(buttonId);
        button.addEventListener('click', function() {
            setLoadingState(button, true);
            fetch(url, { method: 'GET' })
                .then(response => response.json())
                .then(data => {
                    setLoadingState(button, false);
                    if (data.status === 'success') {
                        const formattedText = formatText(data[resultKey]);
                        document.querySelector(resultSelector).innerHTML = `<h3>${button.innerText}</h3><div>${formattedText}</div>`;
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    setLoadingState(button, false);
                    alert('An error occurred. Please try again.');
                });
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        handleButtonClick('get-career-recommendations-btn', '{% url "get_career_recommendations_view" %}', '#career-recommendations', 'career_recommendations');
        handleButtonClick('get-job-prospects-btn', '{% url "get_job_prospects_view" %}', '#job-prospects', 'job_prospects');
        handleButtonClick('assess-skills-btn', '{% url "assess_skills" %}', '#skill-assessment', 'skill_assessment');
        handleButtonClick('get-resume-advice-btn', '{% url "get_resume_advice" %}', '#resume-advice', 'resume_advice');
        handleButtonClick('match-jobs-btn', '{% url "match_jobs" %}', '#matched-jobs', 'matched_jobs');
        handleButtonClick('get-learning-resources-btn', '{% url "get_learning_resources" %}', '#learning-resources', 'learning_resources');
        handleButtonClick('find-networking-opportunities-btn', '{% url "find_networking_opportunities" %}', '#networking-opportunities', 'networking_opportunities');

        // Smooth scroll for sidebar links
        document.querySelectorAll('.sidebar a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });

        // Display formatted saved content
        const savedContent = {
            'career_recommendations': `{% filter escapejs %}{{ profile.career_recommendations|safe }}{% endfilter %}`,
            'job_prospects': `{% filter escapejs %}{{ profile.job_prospects|safe }}{% endfilter %}`,
            'skill_assessment': `{% filter escapejs %}{{ profile.skill_assessment|safe }}{% endfilter %}`,
            'resume_advice': `{% filter escapejs %}{{ profile.resume_advice|safe }}{% endfilter %}`,
            'matched_jobs': `{% filter escapejs %}{{ profile.matched_jobs|safe }}{% endfilter %}`,
            'learning_resources': `{% filter escapejs %}{{ profile.learning_resources|safe }}{% endfilter %}`,
            'networking_opportunities': `{% filter escapejs %}{{ profile.networking_opportunities|safe }}{% endfilter %}`
        };

        for (const [key, value] of Object.entries(savedContent)) {
            if (value) {
                const formattedText = formatText(value);
                document.querySelector(`#${key.replace('_', '-')}`).innerHTML = `<h3>${key.replace('_', ' ')}</h3><div>${formattedText}</div>`;
            }
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        var skillAssessmentData = {{ skill_assessment|safe }};
        
        console.log("Skill Assessment Data:", skillAssessmentData);  // Debug statement

        if (skillAssessmentData && skillAssessmentData.labels && skillAssessmentData.data) {
            var ctx = document.getElementById('skillAssessmentChart').getContext('2d');
            var skillAssessmentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: skillAssessmentData.labels,
                    datasets: [{
                        label: 'Skill Assessment',
                        data: skillAssessmentData.data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 3,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    var levels = ['Beginner', 'Intermediate', 'Advanced'];
                                    return levels[value - 1];
                                }
                            }
                        }
                    }
                }
            });
        } else {
            console.error("Skill Assessment Data is not available or is invalid");
        }
    });
</script>
{% endblock %}
